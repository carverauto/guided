defmodule GuidedWeb.Admin.VulnerabilityLive.Index do
  use GuidedWeb, :live_view

  alias Guided.Graph

  @impl true
  def mount(_params, _session, socket) do
    {:ok, stream(socket, :vulnerabilities, list_vulnerabilities())}
  end

  @impl true
  def handle_params(params, _url, socket) do
    {:noreply, apply_action(socket, socket.assigns.live_action, params)}
  end

  defp apply_action(socket, :edit, %{"id" => id}) do
    socket
    |> assign(:page_title, "Edit Vulnerability")
    |> assign(:vulnerability, get_vulnerability!(id))
  end

  defp apply_action(socket, :new, _params) do
    socket
    |> assign(:page_title, "New Vulnerability")
    |> assign(:vulnerability, %{})
  end

  defp apply_action(socket, :index, _params) do
    socket
    |> assign(:page_title, "Vulnerabilities")
    |> assign(:vulnerability, nil)
  end

  @impl true
  def handle_info({:put_flash, kind, msg}, socket) do
    {:noreply, put_flash(socket, kind, msg)}
  end

  @impl true
  def handle_event("delete", %{"id" => id}, socket) do
    {:ok, _} = Graph.query("MATCH (n:Vulnerability) WHERE id(n) = #{id} DETACH DELETE n")

    {:noreply,
     socket
     |> put_flash(:info, "Vulnerability deleted successfully")
     |> stream(:vulnerabilities, list_vulnerabilities(), reset: true)}
  end

  defp list_vulnerabilities do
    case Graph.query("""
    MATCH (v:Vulnerability)
    RETURN {id: id(v), name: v.name, owasp_rank: v.owasp_rank, severity: v.severity,
            description: v.description, cwe: v.cwe}
    ORDER BY v.name
    """) do
      {:ok, results} ->
        Enum.map(results || [], fn result ->
          %{
            id: result["id"] || 0,
            name: result["name"] || "",
            owasp_rank: result["owasp_rank"] || "",
            severity: result["severity"] || "",
            description: result["description"] || "",
            cwe: result["cwe"] || ""
          }
        end)
      {:error, _} -> []
    end
  end

  defp get_vulnerability!(id) do
    case Graph.query("""
    MATCH (v:Vulnerability)
    WHERE id(v) = #{id}
    RETURN {id: id(v), name: v.name, owasp_rank: v.owasp_rank, severity: v.severity,
            description: v.description, cwe: v.cwe}
    """) do
      {:ok, [result]} ->
        %{
          id: result["id"] || String.to_integer("#{id}"),
          name: result["name"] || "",
          owasp_rank: result["owasp_rank"] || "",
          severity: result["severity"] || "",
          description: result["description"] || "",
          cwe: result["cwe"] || ""
        }
      {:error, _} ->
        %{
          id: String.to_integer("#{id}"),
          name: "",
          owasp_rank: "",
          severity: "",
          description: "",
          cwe: ""
        }
    end
  end

  @impl true
  def render(assigns) do
    ~H"""
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <.header>
        Vulnerabilities
        <:subtitle>Manage security vulnerabilities in the knowledge graph</:subtitle>
        <:actions>
          <.link navigate={~p"/admin"} class="text-sm font-semibold text-gray-600 hover:text-gray-900">
            ‚Üê Back to Dashboard
          </.link>
          <.link patch={~p"/admin/vulnerabilities/new"}>
            <.button>New Vulnerability</.button>
          </.link>
        </:actions>
      </.header>

      <.table
        id="vulnerabilities"
        rows={@streams.vulnerabilities}
        row_click={fn {_id, vulnerability} -> JS.navigate(~p"/admin/vulnerabilities/#{vulnerability.id}/edit") end}
      >
        <:col :let={{_id, vulnerability}} label="Name">{vulnerability.name}</:col>
        <:col :let={{_id, vulnerability}} label="OWASP Rank">{vulnerability.owasp_rank}</:col>
        <:col :let={{_id, vulnerability}} label="CWE">{vulnerability.cwe}</:col>
        <:col :let={{_id, vulnerability}} label="Severity">
          <span class={"inline-flex items-center rounded-md px-2 py-1 text-xs font-medium #{severity_color(vulnerability.severity)}"}>
            {vulnerability.severity}
          </span>
        </:col>
        <:action :let={{_id, vulnerability}}>
          <.link patch={~p"/admin/vulnerabilities/#{vulnerability.id}/edit"}>Edit</.link>
        </:action>
        <:action :let={{id, vulnerability}}>
          <.link
            phx-click={JS.push("delete", value: %{id: vulnerability.id}) |> hide("##{id}")}
            data-confirm="Are you sure?"
          >
            Delete
          </.link>
        </:action>
      </.table>

      <.modal
        :if={@live_action in [:new, :edit]}
        id="vulnerability-modal"
        show
        on_cancel={JS.patch(~p"/admin/vulnerabilities")}
      >
        <.live_component
          module={GuidedWeb.Admin.VulnerabilityLive.FormComponent}
          id={@vulnerability[:id] || :new}
          title={@page_title}
          action={@live_action}
          vulnerability={@vulnerability}
          patch={~p"/admin/vulnerabilities"}
        />
      </.modal>
    </div>
    """
  end

  defp severity_color("critical"), do: "bg-red-50 text-red-700 ring-1 ring-inset ring-red-600/20"
  defp severity_color("high"), do: "bg-orange-50 text-orange-700 ring-1 ring-inset ring-orange-600/20"
  defp severity_color("medium"), do: "bg-yellow-50 text-yellow-700 ring-1 ring-inset ring-yellow-600/20"
  defp severity_color(_), do: "bg-blue-50 text-blue-700 ring-1 ring-inset ring-blue-600/20"
end
